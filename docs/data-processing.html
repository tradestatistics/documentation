<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 2 Data processing | Open Trade Statistics</title>
  <meta name="description" content="Section 2 Data processing | Open Trade Statistics" />
  <meta name="generator" content="bookdown  and GitBook 2.6.7" />

  <meta property="og:title" content="Section 2 Data processing | Open Trade Statistics" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="tradestatistics/documentation" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 2 Data processing | Open Trade Statistics" />
  
  
  

<meta name="author" content="Pachá (Mauricio Vargas Sepúlveda)" />


<meta name="date" content="2019-03-05" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html">
<link rel="next" href="the-mathematics-of-economic-complexity.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.min.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.min.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.min.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.min.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.min.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.min.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Table of Contents</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#project-goals"><i class="fa fa-check"></i><b>1.1</b> Project goals</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#data-availability"><i class="fa fa-check"></i><b>1.2</b> Data availability</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#sources"><i class="fa fa-check"></i><b>1.3</b> Sources</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#code"><i class="fa fa-check"></i><b>1.4</b> Code</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#contact"><i class="fa fa-check"></i><b>1.5</b> Contact</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#donate"><i class="fa fa-check"></i><b>1.6</b> Donate</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data-processing.html"><a href="data-processing.html"><i class="fa fa-check"></i><b>2</b> Data processing</a><ul>
<li class="chapter" data-level="2.1" data-path="data-processing.html"><a href="data-processing.html#tidy-data"><i class="fa fa-check"></i><b>2.1</b> Tidy Data</a></li>
<li class="chapter" data-level="2.2" data-path="data-processing.html"><a href="data-processing.html#filling-gaps-in-our-data"><i class="fa fa-check"></i><b>2.2</b> Filling gaps in our data</a></li>
<li class="chapter" data-level="2.3" data-path="data-processing.html"><a href="data-processing.html#data-cleaning"><i class="fa fa-check"></i><b>2.3</b> Data cleaning</a><ul>
<li class="chapter" data-level="2.3.1" data-path="data-processing.html"><a href="data-processing.html#required-packages"><i class="fa fa-check"></i><b>2.3.1</b> Required packages</a></li>
<li class="chapter" data-level="2.3.2" data-path="data-processing.html"><a href="data-processing.html#custom-function-to-read-data"><i class="fa fa-check"></i><b>2.3.2</b> Custom function to read data</a></li>
<li class="chapter" data-level="2.3.3" data-path="data-processing.html"><a href="data-processing.html#cif-fob-rate-commodity-codes-length-and-iso-codes"><i class="fa fa-check"></i><b>2.3.3</b> CIF-FOB rate, commodity codes length and ISO codes</a></li>
<li class="chapter" data-level="2.3.4" data-path="data-processing.html"><a href="data-processing.html#read-raw-data"><i class="fa fa-check"></i><b>2.3.4</b> Read raw data</a></li>
<li class="chapter" data-level="2.3.5" data-path="data-processing.html"><a href="data-processing.html#clean-data"><i class="fa fa-check"></i><b>2.3.5</b> Clean data</a></li>
<li class="chapter" data-level="2.3.6" data-path="data-processing.html"><a href="data-processing.html#symmetric-clean-data"><i class="fa fa-check"></i><b>2.3.6</b> Symmetric (clean) data</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="data-processing.html"><a href="data-processing.html#github-repositories"><i class="fa fa-check"></i><b>2.4</b> GitHub repositories</a></li>
<li class="chapter" data-level="2.5" data-path="data-processing.html"><a href="data-processing.html#software-information"><i class="fa fa-check"></i><b>2.5</b> Software information</a></li>
<li class="chapter" data-level="2.6" data-path="data-processing.html"><a href="data-processing.html#hardware-information"><i class="fa fa-check"></i><b>2.6</b> Hardware information</a></li>
<li class="chapter" data-level="2.7" data-path="data-processing.html"><a href="data-processing.html#reproducibility-notes"><i class="fa fa-check"></i><b>2.7</b> Reproducibility notes</a></li>
<li class="chapter" data-level="2.8" data-path="data-processing.html"><a href="data-processing.html#coding-style-and-performant-code"><i class="fa fa-check"></i><b>2.8</b> Coding style and performant code</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="the-mathematics-of-economic-complexity.html"><a href="the-mathematics-of-economic-complexity.html"><i class="fa fa-check"></i><b>3</b> The Mathematics of Economic Complexity</a><ul>
<li class="chapter" data-level="3.1" data-path="the-mathematics-of-economic-complexity.html"><a href="the-mathematics-of-economic-complexity.html#revealed-comparative-advantage-rca"><i class="fa fa-check"></i><b>3.1</b> Revealed Comparative Advantage (RCA)</a></li>
<li class="chapter" data-level="3.2" data-path="the-mathematics-of-economic-complexity.html"><a href="the-mathematics-of-economic-complexity.html#smooth-revealed-comparative-advantage-srca"><i class="fa fa-check"></i><b>3.2</b> Smooth Revealed Comparative Advantage (SRCA)</a></li>
<li class="chapter" data-level="3.3" data-path="the-mathematics-of-economic-complexity.html"><a href="the-mathematics-of-economic-complexity.html#diversity-and-ubiquity"><i class="fa fa-check"></i><b>3.3</b> Diversity and Ubiquity</a></li>
<li class="chapter" data-level="3.4" data-path="the-mathematics-of-economic-complexity.html"><a href="the-mathematics-of-economic-complexity.html#reflections-method"><i class="fa fa-check"></i><b>3.4</b> Reflections Method</a></li>
<li class="chapter" data-level="3.5" data-path="the-mathematics-of-economic-complexity.html"><a href="the-mathematics-of-economic-complexity.html#economic-complexity-index-eci"><i class="fa fa-check"></i><b>3.5</b> Economic Complexity Index (ECI)</a></li>
<li class="chapter" data-level="3.6" data-path="the-mathematics-of-economic-complexity.html"><a href="the-mathematics-of-economic-complexity.html#product-complexity-index-pci"><i class="fa fa-check"></i><b>3.6</b> Product Complexity Index (PCI)</a></li>
<li class="chapter" data-level="3.7" data-path="the-mathematics-of-economic-complexity.html"><a href="the-mathematics-of-economic-complexity.html#countries-not-included-in-rankings-and-indicators"><i class="fa fa-check"></i><b>3.7</b> Countries not included in rankings and indicators</a></li>
<li class="chapter" data-level="3.8" data-path="the-mathematics-of-economic-complexity.html"><a href="the-mathematics-of-economic-complexity.html#product-proximity"><i class="fa fa-check"></i><b>3.8</b> Product Proximity</a></li>
<li class="chapter" data-level="3.9" data-path="the-mathematics-of-economic-complexity.html"><a href="the-mathematics-of-economic-complexity.html#country-proximity"><i class="fa fa-check"></i><b>3.9</b> Country Proximity</a></li>
<li class="chapter" data-level="3.10" data-path="the-mathematics-of-economic-complexity.html"><a href="the-mathematics-of-economic-complexity.html#product-density"><i class="fa fa-check"></i><b>3.10</b> Product Density</a></li>
<li class="chapter" data-level="3.11" data-path="the-mathematics-of-economic-complexity.html"><a href="the-mathematics-of-economic-complexity.html#country-density"><i class="fa fa-check"></i><b>3.11</b> Country Density</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="datasets.html"><a href="datasets.html"><i class="fa fa-check"></i><b>4</b> Datasets</a><ul>
<li class="chapter" data-level="4.1" data-path="datasets.html"><a href="datasets.html#code-of-conduct"><i class="fa fa-check"></i><b>4.1</b> Code of Conduct</a></li>
<li class="chapter" data-level="4.2" data-path="datasets.html"><a href="datasets.html#compressed-data"><i class="fa fa-check"></i><b>4.2</b> Compressed data</a><ul>
<li class="chapter" data-level="4.2.1" data-path="datasets.html"><a href="datasets.html#how-to-use"><i class="fa fa-check"></i><b>4.2.1</b> How to use</a></li>
<li class="chapter" data-level="4.2.2" data-path="datasets.html"><a href="datasets.html#available-datasets"><i class="fa fa-check"></i><b>4.2.2</b> Available datasets</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="datasets.html"><a href="datasets.html#api"><i class="fa fa-check"></i><b>4.3</b> API</a><ul>
<li class="chapter" data-level="4.3.1" data-path="datasets.html"><a href="datasets.html#available-tables"><i class="fa fa-check"></i><b>4.3.1</b> Available tables</a></li>
<li class="chapter" data-level="4.3.2" data-path="datasets.html"><a href="datasets.html#metadata"><i class="fa fa-check"></i><b>4.3.2</b> Metadata</a></li>
<li class="chapter" data-level="4.3.3" data-path="datasets.html"><a href="datasets.html#api-parameters"><i class="fa fa-check"></i><b>4.3.3</b> API parameters</a></li>
<li class="chapter" data-level="4.3.4" data-path="datasets.html"><a href="datasets.html#available-reporters"><i class="fa fa-check"></i><b>4.3.4</b> Available reporters</a></li>
<li class="chapter" data-level="4.3.5" data-path="datasets.html"><a href="datasets.html#yrpc-year-reporter-partner-and-commodity"><i class="fa fa-check"></i><b>4.3.5</b> YRPC (Year, Reporter, Partner and Commodity)</a></li>
<li class="chapter" data-level="4.3.6" data-path="datasets.html"><a href="datasets.html#yrc-year-reporter-and-commodity"><i class="fa fa-check"></i><b>4.3.6</b> YRC (Year, Reporter and Commodity)</a></li>
<li class="chapter" data-level="4.3.7" data-path="datasets.html"><a href="datasets.html#yrp-year-reporter-and-partner"><i class="fa fa-check"></i><b>4.3.7</b> YRP (Year, Reporter and Partner)</a></li>
<li class="chapter" data-level="4.3.8" data-path="datasets.html"><a href="datasets.html#yc-year-and-commodity"><i class="fa fa-check"></i><b>4.3.8</b> YC (Year and Commodity)</a></li>
<li class="chapter" data-level="4.3.9" data-path="datasets.html"><a href="datasets.html#country-rankings"><i class="fa fa-check"></i><b>4.3.9</b> Country rankings</a></li>
<li class="chapter" data-level="4.3.10" data-path="datasets.html"><a href="datasets.html#product-rankings"><i class="fa fa-check"></i><b>4.3.10</b> Product rankings</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>5</b> References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Open Trade Statistics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="data-processing" class="section level1">
<h1><span class="header-section-number">Section 2</span> Data processing</h1>
<div id="tidy-data" class="section level2">
<h2><span class="header-section-number">2.1</span> Tidy Data</h2>
<p>We followed Tidy Data principles exposed in <span class="citation">[<a href="#ref-tidydata2014">1</a>]</span> and <span class="citation">[<a href="#ref-r4ds2016">2</a>]</span>. Those principles are closely tied to those of relational databases and Codd’s relational algebra.</p>
<div class="figure"><span id="fig:unnamed-chunk-1"></span>
<img src="fig/tidy-data.svg" alt="Data pipeline"  />
<p class="caption">
Figure 2.1: Data pipeline
</p>
</div>
</div>
<div id="filling-gaps-in-our-data" class="section level2">
<h2><span class="header-section-number">2.2</span> Filling gaps in our data</h2>
<p>We use mirrored flows to cover gaps in raw data. Some countries report zero exports for some products, but we can inspect what their trade partners reported. If country A reported zero exports (imports) of product B to (from) country C, then we searched what country C reported of imports (exports) of product B from (to) country A.</p>
<p>Exports are reported FOB (free on board) while imports are reported CIF (cost, insurance and freight). When country A sends products to country C that will be registered with a larger value when it arrives to destination because the importer is including cost, insurance and freight that was not registered before shipping. There are different approaches to solve this difficulty, and in particular <span class="citation">[<a href="#ref-tradecosts2004">3</a>]</span>, <span class="citation">[<a href="#ref-geography2009">4</a>]</span> and <span class="citation">[<a href="#ref-baci2010">5</a>]</span> discuss this in detail and propose that an 8% CIF/FOB ratio is suitable to discount costs and compare imports and exports.</p>
<p>There are some noble and remarkable approaches such as gravitational models. As, to our knowledge at the moment, there is no literature reporting the estimation of a gravity equation for this purpose that returns a satisfactory fitting.</p>
<p>Let <span class="math inline">\(x_{c,c&#39;,p}\)</span> represent the exports of country <span class="math inline">\(c\)</span> to country <span class="math inline">\(c&#39;\)</span> in product <span class="math inline">\(p\)</span> and <span class="math inline">\(m_{c&#39;,c,p}\)</span> the imports of country <span class="math inline">\(c&#39;\)</span> from country <span class="math inline">\(c\)</span>. Under this notation we defined corrected flows as:</p>
<p><span class="math display">\[\hat{x}_{c,c&#39;,p} = \max\left\{x_{c,c&#39;,p}, \frac{m_{c&#39;,c,p}}{1.08}\right\}\]</span> <span class="math display">\[\hat{m}_{c,c&#39;,p} = \max\left\{x_{c&#39;,c,p}, \frac{m_{c,c&#39;,p}}{1.08}\right\}\]</span> After symmetrization all observations are rounded to zero decimals.</p>
</div>
<div id="data-cleaning" class="section level2">
<h2><span class="header-section-number">2.3</span> Data cleaning</h2>
<p>You can check the GitHub repository, but here we provide a simplified and commented example that reproduces the exact steps we performed to clean the data.</p>
<p>Provided that Comtrade raw data cannot be redistributed, I’ll limit the example to five reporters in the year 1962 (the first year with available data).</p>
<p>Let’s define two files for the example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">raw_file &lt;-<span class="st"> &quot;raw_data_1962_5_reporters.rda&quot;</span>
clean_file &lt;-<span class="st"> &quot;clean_data_1962_5_reporters.rda&quot;</span></code></pre></div>
<div id="required-packages" class="section level3">
<h3><span class="header-section-number">2.3.1</span> Required packages</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(data.table)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(stringr)
<span class="kw">library</span>(purrr)
<span class="kw">library</span>(janitor)</code></pre></div>
</div>
<div id="custom-function-to-read-data" class="section level3">
<h3><span class="header-section-number">2.3.2</span> Custom function to read data</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fread2 &lt;-<span class="st"> </span><span class="cf">function</span>(file, <span class="dt">select =</span> <span class="ot">NULL</span>, <span class="dt">character =</span> <span class="ot">NULL</span>, <span class="dt">numeric =</span> <span class="ot">NULL</span>) {
  <span class="cf">if</span>(<span class="kw">str_sub</span>(file, <span class="dt">start =</span> <span class="op">-</span><span class="dv">2</span>) <span class="op">==</span><span class="st"> &quot;gz&quot;</span>) {
    d &lt;-<span class="st"> </span><span class="kw">fread</span>(
      <span class="dt">cmd =</span> <span class="kw">paste</span>(<span class="st">&quot;zcat&quot;</span>, file),
      <span class="dt">select =</span> select,
      <span class="dt">colClasses =</span> <span class="kw">list</span>(
        <span class="dt">character =</span> character,
        <span class="dt">numeric =</span> numeric
      )
    ) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">clean_names</span>()
  } <span class="cf">else</span> {
    d &lt;-<span class="st"> </span><span class="kw">fread</span>(
      <span class="dt">input =</span> file,
      <span class="dt">select =</span> select,
      <span class="dt">colClasses =</span> <span class="kw">list</span>(
        <span class="dt">character =</span> character,
        <span class="dt">numeric =</span> numeric
      )
    ) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">clean_names</span>()
  }
  
  <span class="kw">return</span>(d)
}</code></pre></div>
</div>
<div id="cif-fob-rate-commodity-codes-length-and-iso-codes" class="section level3">
<h3><span class="header-section-number">2.3.3</span> CIF-FOB rate, commodity codes length and ISO codes</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># CIF-FOB rate ------------------------------------------------------------</span>
    
<span class="co"># See Anderson &amp; van Wincoop, 2004, Hummels, 2006 and Gaulier &amp; Zignago, 2010 about 8% rate consistency</span>
cif_fob_rate &lt;-<span class="st"> </span><span class="fl">1.08</span>

<span class="co"># Commodity codes length --------------------------------------------------</span>

J &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">6</span>)

<span class="co"># ISO-3 codes -------------------------------------------------------------</span>
    
<span class="kw">load</span>(<span class="st">&quot;../comtrade-codes/01-2-tidy-country-data/country-codes.RData&quot;</span>)
    
country_codes &lt;-<span class="st"> </span>country_codes <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(iso3_digit_alpha) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">iso3_digit_alpha =</span> <span class="kw">str_to_lower</span>(iso3_digit_alpha)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>iso3_digit_alpha <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;wld&quot;</span>,<span class="st">&quot;null&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as_vector</span>()</code></pre></div>
</div>
<div id="read-raw-data" class="section level3">
<h3><span class="header-section-number">2.3.4</span> Read raw data</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(raw_file)) {
  raw_data &lt;-<span class="st"> </span><span class="kw">fread2</span>(
    <span class="st">&quot;../yearly-datasets/01-raw-data/sitc-rev1/gz/type-C_r-ALL_ps-1962_freq-A_px-S1_pub-20050214_fmt-csv_ex-20151113.csv.gz&quot;</span>,
    <span class="dt">select =</span> <span class="kw">c</span>(<span class="st">&quot;Year&quot;</span>, <span class="st">&quot;Aggregate Level&quot;</span>, <span class="st">&quot;Trade Flow&quot;</span>, <span class="st">&quot;Reporter ISO&quot;</span>, <span class="st">&quot;Partner ISO&quot;</span>, <span class="st">&quot;Commodity Code&quot;</span>, <span class="st">&quot;Trade Value (US$)&quot;</span>),
    <span class="dt">character =</span> <span class="st">&quot;Commodity Code&quot;</span>,
    <span class="dt">numeric =</span> <span class="st">&quot;Trade Value (US$)&quot;</span>
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(
      reporter_iso <span class="op">==</span><span class="st"> &quot;CHL&quot;</span>,
      partner_iso <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;ARG&quot;</span>, <span class="st">&quot;BRA&quot;</span>, <span class="st">&quot;PER&quot;</span>, <span class="st">&quot;USA&quot;</span>)
    )
  
  <span class="kw">save</span>(raw_data, <span class="dt">file =</span> raw_file, <span class="dt">compress =</span> <span class="st">&quot;xz&quot;</span>)
  
  raw_data
} <span class="cf">else</span> {
  <span class="kw">load</span>(raw_file)
  
  raw_data
}</code></pre></div>
<pre><code>## # A tibble: 2,606 x 7
##     year aggregate_level trade_flow reporter_iso partner_iso commodity_code
##    &lt;int&gt;           &lt;int&gt; &lt;chr&gt;      &lt;chr&gt;        &lt;chr&gt;       &lt;chr&gt;         
##  1  1962               3 Import     CHL          BRA         071           
##  2  1962               3 Import     CHL          PER         071           
##  3  1962               3 Import     CHL          USA         071           
##  4  1962               4 Export     CHL          PER         2218          
##  5  1962               3 Export     CHL          ARG         265           
##  6  1962               3 Import     CHL          BRA         265           
##  7  1962               3 Import     CHL          PER         265           
##  8  1962               3 Import     CHL          USA         265           
##  9  1962               5 Export     CHL          BRA         29193         
## 10  1962               5 Export     CHL          USA         29193         
## # … with 2,596 more rows, and 1 more variable: trade_value_us &lt;dbl&gt;</code></pre>
</div>
<div id="clean-data" class="section level3">
<h3><span class="header-section-number">2.3.5</span> Clean data</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(clean_file)) {
  clean_data &lt;-<span class="st"> </span>raw_data <span class="op">%&gt;%</span>
<span class="st">    </span>
<span class="st">    </span><span class="kw">rename</span>(<span class="dt">trade_value_usd =</span> trade_value_us) <span class="op">%&gt;%</span>
<span class="st">    </span>
<span class="st">    </span><span class="kw">filter</span>(aggregate_level <span class="op">%in%</span><span class="st"> </span>J) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(trade_flow <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Export&quot;</span>,<span class="st">&quot;Import&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span>
<span class="st">    </span><span class="kw">filter</span>(
      <span class="op">!</span><span class="kw">is.na</span>(commodity_code),
      commodity_code <span class="op">!=</span><span class="st"> &quot;&quot;</span>,
      commodity_code <span class="op">!=</span><span class="st"> &quot; &quot;</span>
    ) <span class="op">%&gt;%</span>
<span class="st">    </span>
<span class="st">    </span><span class="kw">mutate</span>(
      <span class="dt">reporter_iso =</span> <span class="kw">str_to_lower</span>(reporter_iso),
      <span class="dt">partner_iso =</span> <span class="kw">str_to_lower</span>(partner_iso)
    ) <span class="op">%&gt;%</span>
<span class="st">    </span>
<span class="st">    </span><span class="kw">filter</span>(
      reporter_iso <span class="op">%in%</span><span class="st"> </span>country_codes,
      partner_iso <span class="op">%in%</span><span class="st"> </span>country_codes
    )
  
  <span class="kw">save</span>(clean_data, <span class="dt">file =</span> clean_file, <span class="dt">compress =</span> <span class="st">&quot;xz&quot;</span>)
  
  clean_data
} <span class="cf">else</span> {
  <span class="kw">load</span>(clean_file)
  
  clean_data
}</code></pre></div>
<pre><code>## # A tibble: 949 x 7
##     year aggregate_level trade_flow reporter_iso partner_iso commodity_code
##    &lt;int&gt;           &lt;int&gt; &lt;chr&gt;      &lt;chr&gt;        &lt;chr&gt;       &lt;chr&gt;         
##  1  1962               4 Export     chl          per         2218          
##  2  1962               4 Import     chl          usa         5129          
##  3  1962               4 Import     chl          usa         5153          
##  4  1962               4 Import     chl          arg         5417          
##  5  1962               4 Export     chl          per         6822          
##  6  1962               4 Import     chl          usa         6822          
##  7  1962               4 Export     chl          usa         6822          
##  8  1962               4 Import     chl          usa         6862          
##  9  1962               4 Import     chl          usa         6934          
## 10  1962               4 Import     chl          arg         7141          
## # … with 939 more rows, and 1 more variable: trade_value_usd &lt;dbl&gt;</code></pre>
</div>
<div id="symmetric-clean-data" class="section level3">
<h3><span class="header-section-number">2.3.6</span> Symmetric (clean) data</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Exports data ------------------------------------------------------------</span>

exports &lt;-<span class="st"> </span>clean_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(trade_flow <span class="op">==</span><span class="st"> &quot;Export&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(reporter_iso, partner_iso, commodity_code, trade_value_usd) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">trade_value_usd =</span> <span class="kw">ceiling</span>(trade_value_usd))

exports_mirrored &lt;-<span class="st"> </span>clean_data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(trade_flow <span class="op">==</span><span class="st"> &quot;Import&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(reporter_iso, partner_iso, commodity_code, trade_value_usd) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">trade_value_usd =</span> <span class="kw">ceiling</span>(trade_value_usd <span class="op">/</span><span class="st"> </span>cif_fob_rate))

<span class="co"># Reporter and Partner must be inverted</span>
<span class="kw">colnames</span>(exports_mirrored) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;partner_iso&quot;</span>, <span class="st">&quot;reporter_iso&quot;</span>, <span class="st">&quot;commodity_code&quot;</span>, <span class="st">&quot;trade_value_usd&quot;</span>)

exports_model &lt;-<span class="st"> </span>exports <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">full_join</span>(exports_mirrored, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;reporter_iso&quot;</span>, <span class="st">&quot;partner_iso&quot;</span>, <span class="st">&quot;commodity_code&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rowwise</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">trade_value_usd =</span> <span class="kw">max</span>(trade_value_usd.x, trade_value_usd.y, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">commodity_code_parent =</span> <span class="kw">str_sub</span>(commodity_code, <span class="dv">1</span>, <span class="dv">4</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(reporter_iso, partner_iso, commodity_code_parent) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parent_count =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(reporter_iso, partner_iso, commodity_code, commodity_code_parent, parent_count, trade_value_usd)

exports_model_unrepeated_parent &lt;-<span class="st"> </span>exports_model <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(parent_count <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)

exports_model_repeated_parent &lt;-<span class="st"> </span>exports_model <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(
    parent_count <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>,
    <span class="kw">str_length</span>(commodity_code) <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">6</span>)
  )

exports_model_repeated_parent_summary &lt;-<span class="st"> </span>exports_model_repeated_parent <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(reporter_iso, partner_iso, commodity_code_parent) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">trade_value_usd =</span> <span class="kw">sum</span>(trade_value_usd, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">commodity_code =</span> commodity_code_parent)

exports_model &lt;-<span class="st"> </span>exports_model_unrepeated_parent <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">bind_rows</span>(exports_model_repeated_parent) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">bind_rows</span>(exports_model_repeated_parent_summary) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(reporter_iso, partner_iso, commodity_code) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">year =</span> <span class="dv">2016</span>,
    <span class="dt">commodity_code_length =</span> <span class="kw">str_length</span>(commodity_code)
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(year, reporter_iso, partner_iso, commodity_code, commodity_code_length, trade_value_usd) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(trade_value_usd <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)

exports_model</code></pre></div>
<pre><code>## # A tibble: 949 x 6
##     year reporter_iso partner_iso commodity_code commodity_code_…
##    &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;       &lt;chr&gt;                     &lt;int&gt;
##  1  2016 arg          chl         0011                          4
##  2  2016 arg          chl         0012                          4
##  3  2016 arg          chl         0013                          4
##  4  2016 arg          chl         0015                          4
##  5  2016 arg          chl         0111                          4
##  6  2016 arg          chl         0112                          4
##  7  2016 arg          chl         0113                          4
##  8  2016 arg          chl         0118                          4
##  9  2016 arg          chl         0121                          4
## 10  2016 arg          chl         0133                          4
## # … with 939 more rows, and 1 more variable: trade_value_usd &lt;dbl&gt;</code></pre>
</div>
</div>
<div id="github-repositories" class="section level2">
<h2><span class="header-section-number">2.4</span> GitHub repositories</h2>
<ul>
<li><a href="https://github.com/tradestatistics/yearly-datasets">Getting and cleaning data from UN COMTRADE (OTS Yearly Data)</a></li>
<li><a href="https://github.com/tradestatistics/atlas-data">Scraping data from The Atlas of Economic Complexity (OTS Atlas Data)</a></li>
<li><a href="https://github.com/tradestatistics/comtrade-codes">Product and country codes (OTS Comtrade Codes)</a></li>
<li><a href="https://github.com/tradestatistics/packrat-library/">R packages library for reproducibility (OTS Packrat Library)</a></li>
</ul>
</div>
<div id="software-information" class="section level2">
<h2><span class="header-section-number">2.5</span> Software information</h2>
<p>We used R 3.4.3 and RStudio Desktop 1.1 on Ubuntu Desktop 18.04.</p>
<p>We built R from binaries in order to obtain a setup linked with multi-threaded numeric libraries. Our build is linked to OpenBLAS which we used over alternatives such as Intel MKL, BLAS or ATLAS that can also be used.</p>
<p>If you use Windows the scripts will only use a single core because we used a parallelization that depends on fork system call that is only supported on Unix systems. You can always run the scripts on Windows and the only difference will be that it will use less RAM and it will be slower to compute.</p>
<p>Also, before running the scripts on Windows verify that you installed GNU Utilities beforehand. One easy option is to install <a href="https://chocolatey.org/">Chocolatey</a> first and then install the GNU Utilities by running <code>choco install unxutils</code> on Cmd or Power Shell as administrator.</p>
</div>
<div id="hardware-information" class="section level2">
<h2><span class="header-section-number">2.6</span> Hardware information</h2>
<p>All the data processing was done by using a Lenovo Thinkpad L380 that features an Intel i5-8250U 1.60 GHz processor and 32 GB (two DDR4 cards of sixteen gigabytes each).</p>
<p>The functions are executed using parallelization on four cores because empirically we detected and overhead due to data communication with the cores when using more cores.</p>
<p>Please notice that running our scripts with parallelization demands more RAM than the amount you can find on an average laptop. You can always disable parallelization in the scripts or reduce the default number of cores.</p>
</div>
<div id="reproducibility-notes" class="section level2">
<h2><span class="header-section-number">2.7</span> Reproducibility notes</h2>
<p>To guarantee reproducibility we provide <a href="https://rstudio.github.io/packrat/">Packrat</a> snapshot and bundles. This prevents changes in syntax, functions or dependencies.</p>
<p>Our R installation is isolated from apt-get to avoid any accidental updates that can alter the data pipeline and/or the output.</p>
<p>The projects are related to each other. In order to avoid multiple copies of files some projects read files from other projects. For example, <a href="https://github.com/tradestatistics/yearly-datasets">OTS Yearly Datasets</a> input is the output of <a href="https://github.com/tradestatistics/atlas-data">OTS Atlas Data</a>.</p>
<p>The only reproducibility flaw of this project lies in data downloading. Obtaining raw datasets from UN COMTRADE demands an API key that can only be obtained with institutional access that is limited to some universities and institutes.</p>
</div>
<div id="coding-style-and-performant-code" class="section level2">
<h2><span class="header-section-number">2.8</span> Coding style and performant code</h2>
<p>We used the <a href="http://style.tidyverse.org/">Tidyverse Style Guide</a>. As cornerstone references for performant code we followed <span class="citation">[<a href="#ref-advancedr2014">6</a>]</span> and <span class="citation">[<a href="#ref-masteringsoftware2017">7</a>]</span>.</p>
<p>Some matrix operations are written in Rcpp to take advantage of C++ speed. To take full advantage of hardware and numerical libraries we am using sparse matrices as it is explained in <span class="citation">[<a href="#ref-rcpparmadillo2018">8</a>]</span>.</p>

</div>
</div>
<h3> References</h3>
<div id="refs" class="references">
<div id="ref-tidydata2014">
<p>[1] H. Wickham, “Tidy data,” <em>Journal of Statistical Software, Articles</em>, vol. 59, no. 10, pp. 1–23, 2014.</p>
</div>
<div id="ref-r4ds2016">
<p>[2] H. Wickham and G. Grolemund, <em>R for data science: Import, tidy, transform, visualize, and model data</em>. O’Reilly Media, Inc., 2016.</p>
</div>
<div id="ref-tradecosts2004">
<p>[3] J. E. Anderson and E. Van Wincoop, “Trade costs,” <em>Journal of Economic literature</em>, vol. 42, no. 3, pp. 691–751, 2004.</p>
</div>
<div id="ref-geography2009">
<p>[4] D. Hummels, “Toward a geography of trade costs,” 1999.</p>
</div>
<div id="ref-baci2010">
<p>[5] G. Gaulier and S. Zignago, “Baci: International trade database at the product-level (the 1994-2007 version),” 2010.</p>
</div>
<div id="ref-advancedr2014">
<p>[6] H. Wickham, <em>Advanced r</em>. CRC Press, 2014.</p>
</div>
<div id="ref-masteringsoftware2017">
<p>[7] R. Peng, S. Kross, and B. Anderson, <em>Mastering software development in R</em>. Leanpub, 2017.</p>
</div>
<div id="ref-rcpparmadillo2018">
<p>[8] B. Ni, D. Selivanov, D. Eddelbuettel, and Q. Kou, “RcppArmadillo: Sparse matrix support,” Comprehensive R Archive Network, 2018.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="the-mathematics-of-economic-complexity.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
